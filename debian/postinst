#!/bin/bash

if [ "$1" == "configure" ] && [ -z "$2" ]; then
	# if $2 is null we are installing, run first setting code
	echo "Creating virtual environment for UniTotem and installing required dependencies"
	python3 -m venv /var/unitotem-venv --system-site-packages --copy
	setcap CAP_NET_BIND_SERVICE=+eip /var/unitotem-venv/bin/python
	setcap CAP_NET_BIND_SERVICE=+eip /var/unitotem-venv/bin/python3
	/var/unitotem-venv/bin/pip3 install -r #TODO requirements.txt
	# /var/unitotem-venv/bin/pip3 install python-crontab requests validators decorator qrcode PyChromeDevTools pymediainfo ruamel.yaml pillow
	# fastapi, (starlette), uvicorn, python-multipart, jinja2, Werkzeug, websockets


	echo "Creating ssl key for UniTotem"
	openssl req -x509 -nodes -newkey rsa:2048 -keyout "/etc/ssl/unitotem_key.pem" -out "/etc/ssl/unitotem_crt.pem" -days 365000 -subj "/C=../ST=./L=./O=a13ssandr0/OU=UniTotem/CN=UniTotem/emailAddress=."
	cat /etc/ssl/unitotem_{crt,key}.pem > "/etc/ssl/unitotem.pem"
	rm /etc/ssl/unitotem_{crt,key}.pem
	chmod 0600 "/etc/ssl/unitotem.pem"

# 	if [ -f /etc/haproxy/haproxy.cfg ]; then
# 	echo "Adding UniTotem haproxy configuration"
# 	cat >> /etc/haproxy/haproxy.cfg << EOF
# ### UniTotem section, DO NOT EDIT ###

# frontend unitotem-frontend
# 	mode http
# 	bind :80
# 	bind :443 ssl crt /etc/ssl/unitotem.pem
# 	http-request redirect scheme https code 301 unless { ssl_fc }
# 	default_backend unitotem

# backend unitotem
# 	option forwardfor
# 	server unitotem1 127.0.0.1:5000

# ### End UniTotem section
# EOF
# 	fi

fi


# https://stackoverflow.com/questions/66775654/how-can-i-make-pulseaudio-run-as-root

if [ "$1" == "configure" ]; then
	# check if chromium allows remote control
	# this means the systems is configured for running UniTotem
	grep -Fq "remote-debugging-port" /etc/X11/xinit/xinitrc
	if [[ $? -eq 0 ]]; then
		# if the string "no-user-gesture-required" is not present
		# we are surely updating from an older version of UniTotem that
		# let chromium automatically generate pages for displaying images and videos
		# new pages generated by UniTotem need this flag to allow autoplay
		grep -Fq "no-user-gesture-required" /etc/X11/xinit/xinitrc
		if [[ $? -ne 0 ]]; then
			awk '/--incognito.*/{print "\t--autoplay-policy=no-user-gesture-required \\"}1' /etc/X11/xinit/xinitrc > /etc/X11/xinit/xinitrc.tmp
			mv /etc/X11/xinit/xinitrc.tmp /etc/X11/xinit/xinitrc
		fi
	fi
fi

#DEBHELPER#